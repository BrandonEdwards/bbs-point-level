\documentclass[12pt]{article}

\usepackage{setspace}
\doublespacing

\usepackage{natbib}
\bibliographystyle{apalike}

\usepackage[margin=1.0in]{geometry}

\usepackage{amsmath}

\usepackage{lineno}
\linenumbers

%opening
\title{A point-level trend model for the North American Breeding Bird Survey that corrects for detectability}
\author{
	Edwards, Brandon P.M.\\
	\and
	Johnston, Alison\\
	\and
	Miller, David L.\\
	\and
	Bennett, Joseph R.\\
	\and
	Smith, Adam C.\\
}

\begin{document}
	
	\maketitle
	
	%\begin{abstract}
		
%	\end{abstract}
	
\section{Introduction}
\par Data for the North American Breeding Bird Survey (BBS) have been collected since the 1960s when the BBS first started. 
The protocol has remained essentially the same since. 
Each year, observers run their BBS "route", which consists of 50, 3-minute point counts spaced roughly 800 m apart from each other. 
The observer is instructed to record every bird they see or hear within a 400 m radius of each point, during each of the 3-minute point counts. 
These data are then modelled as follows:

\begin{equation*}
	Y_{J,i,t,o} | \alpha_i, \delta_{i,t}, \gamma_{i,t}, \psi_J, \omega_o, \eta \sim NegBin(\lambda_{J,i,t,o}, \nu)
\end{equation*}
\begin{equation}\label{bbs}
\log(\lambda_{J,i,t,o}) = \alpha_i + \delta_{i,t} + \gamma_{i,t} + \psi_J + \omega_o + \eta I(o,J,t) + \epsilon_{J,i,t,o}.
\end{equation}

Counts $Y$ for each route $J$ in stratum $i$, in year $t$ observed by observer $o$ are modelled as realizations of a negative binomial distribution with mean $\lambda_{J,i,t,o}$ and inverse dispersion parameter $\nu$ \citet{smith_spatially_2023}. 
Note that we have explicitly chosen to use capital letter $J$ to represent the route, as this will be differentiated from specific points $j$ within a route $J$ later in this paper.
On the log scale, values of $\lambda$ are modelled by intercepts representing mean count for each stratum ($\alpha_i$), route($\psi_J$), and observer ($\omega_o$), plus a temporal component $\delta_{i,t}$ that estimates population trajectory through time. 
Since the temporal component is a smoothed GAM, we also add in an annual fluctuation term $\gamma_{i,t}$ to allow for fluctuations from the smooth. 
We also have a first-year observer term $\eta$ that is present if the route $J$ in year $t$ is run by observer $o$ for the first time, and is zero otherwise. 
Finally, we also have a random noise term $\epsilon_{J,i,t,o}$.

\par To estimate annual population indices, we use the population index calculation used in \citet{smith_north_2020} to calculate indices of abundance at a stratified level:

\begin{equation}\label{index}
	n_{i,t} = \dfrac{\sum_{J\in S_i}\exp(\alpha_i + \psi_J + \delta_{i,t})}{|S_i|}
\end{equation}

That is, the index of abundance $n$ at stratum $i$ in year $t$ will be the exponentiated sum of the stratum effects $\alpha_i$, route effect $\psi_J$, and year effect $\delta_{i,t}$ for each route in stratum $S_i$, averaged over the number of routes in stratum $S_i$.
As such, each index represents the expected count on an average BBS route conducted by an average observer in a given year \citep{smith_north_2020}.
These indices are then used to calculate trend from year $t_a$ to year $t_b$ as

\begin{equation*}
	T_{a:b} = 100 \times \left( \left( \dfrac{N_{t_a}}{N_{t_b}} ^ {\dfrac{1}{t_a - t_b}} \right) - 1 \right)
\end{equation*}

where $N_t$ is the index of abundance in given year and stratum.
These trends have been used as the gold standard of trend estimates for North American bird populations for decades, and have informed numerous important reports such as the State of Canada's Birds (CITE) and State of North American Birds (CITE), and have been used to estimate the overall loss of close to three billion birds since the 1970s. 

Given the recent detectability offsets generated by the NA-POPS project \citep{edwards_point_2023}, it would be useful to be able to incorporate these detectability offsets into the current BBS status and trends model. 
Incorporating these offsets can serve several purposes, from correcting for roadside and landcover biases via statistical offsets \citep{thogmartin_sensitivity_2010, solymos_lessons_2020, edwards_point_2023}, to integrating disparate data sources \citep{solymos_calibrating_2013, edwards_point_2023}. 
However, because the current BBS model considers summed counts at the route level (rather than at the individual point level), we cannot yet directly apply these offsets to BBS data. 

\par In this paper, we describe an extension of the current BBS status and trend model (i.e., Equation \ref{bbs}) that considers BBS data at the point-level. 
Using point-level (also called stop-level) data, we compare trends and trajectories of Ovenbird (SCIENTIFIC NAME) obtained through this point-level model to trends and trajectories obtained through the current route-level BBS models described in \citet{smith_spatially_2023}.
After establishing this baseline comparison, we incorporate detectability offsets into the new point-level model in two ways: first using a naive approach that considers these detectability offsets as true point values, and secondly by incorporating error associated with the derived detectability offsets and propagating forward the uncertainty using methods described in \citet{bravington_variance_2021}.
Finally, we investigate how incorporating detectability as offsets in both of these ways affects the trends and trajectories for Ovenbird across Canada, and in particular focus on areas where there has been large landcover changes.

\section{Methods}

\par The following subsections describe how the current route-level description of the model can be converted to a point-level model, by taking advantage of the stop-level data provided by the United States Geological Survey and Canadian Wildlife Service. 
We then expand this point-level model to explicitly include detectability estimates, as well as uncertainty around those estimates. 
Finally, we demonstrate the point-level model and the detectability model by modelling counts of Ovenbird (SCIENTIFIC NAME) in Ontario from 2010 - 2022, and compare trends and trajectories from these models to trends and trajectories obtained from the route-level model in \citet{smith_spatially_2023}.

\subsection{Models}

\subsubsection{A Point-level Model for Modelling BBS Data}

\par Recall that the model described in Equation \ref{bbs} sums all points within a route $J$ and models these summed counts for each route $J$, such that the term $\psi_J$ is the route-level random effect and $\log(\lambda_{j,i,t,o})$ represents the mean expected count at route $J$ in stratum $i$ during year $t$ by observer $o$.
Rather than modelling at the route-level $J$, we can consider each individual point or "stop" within a route as an independent count.
We would then be modelling at the point-level $j$.
The term $\psi_j$ would now represent a point-level random effect, and $\log(\lambda_{j,i,t,o})$ would represent the mean expected count at point $j$ in stratum $i$ during year $t$ by observer $o$. 

\begin{equation*}
	Y_{j,i,t,o} | \alpha_i, \delta_{i,t}, \gamma_{i,t}, \psi_j, \omega_o, \eta \sim NegBin(\lambda_{j,i,t,o}, \nu)
\end{equation*}
\begin{equation}\label{bbs-point}
	\log(\lambda_{j,i,t,o}) = \alpha_i + \delta_{i,t} + \gamma_{i,t} + \psi_j + \omega_o + \eta I(o,j,t) + \epsilon_{j,i,t,o}
\end{equation}

Note that this is nearly identical to the original route model outlined in Equation \ref{bbs}, except that we are considering point $j$ rather than route $J$.
Additionally, the index of abundance calculation described in Equation \ref{index} would also remain nearly identical, except that the summation term would be summing over all points $j$ in stratum $S_i$, rather than all routes $J$ in stratum $S_i$. 
That is, each $n_{i,t}$ would represent the expected count on an average BBS point conducted by an average observer in a given year.

\subsubsection{A Point-level Model that Explicitly Includes Detectability}

\par Equation \ref{bbs-point} gives us the ability to model specifically at the point-count level, which provides us the opportunity to incorporate point-specific effects such as detectability.
Changes in detectability will affect how many birds are counted during a given point count, relative to the total number of birds are actually present at the site. 
Here, we will incorporate detectability as an offset, such that each count is adjusted based on the duration of the survey, maximum point-count radius, and combinations of survey start time and survey time of year (which affect probability of availability $p$), as well as roadside effects and forest coverage (which affect perception probability $q$). 
Thus, the specific offset at point $j$, year $t$, in stratum $i$ would be given by $\log(p q)_{j,i,t}$, and our model becomes:


\begin{equation*}
	Y_{j,i,t,o} | \alpha_i, \delta_{i,t}, \gamma_{i,t}, \psi_j, \omega_o, \eta \sim NegBin \left( \dfrac{\lambda_{j,i,t,o}}{p_{j,i,t}q_{j,i,t}}, \nu \right)
\end{equation*}
\begin{equation}\label{bbs-detect}
	\log(\lambda_{j,i,t,o}) = \log(p_{j,i,t}q_{j,i,t}) + \alpha_i + \delta_{i,t} + \gamma_{i,t} + \psi_j + \omega_o + \eta I(o,j,t) + \epsilon_{j,i,t,o}.
\end{equation}

\par When calculating the index of abundance, we could calculate the index at each point given the specific detectability conditions at that point in time.
In that case, we would include the term $\log(p_{j,i,t}q_{j,i,t})$ in the exponent of Equation \ref{index}.
Alternatively, we could calculate the index of abundance under perfect detection: if we set $p = q = 1$, then $\log(p_{j,i,t}q_{j,i,t}) = \log(1) = 0$, and our original index of abundance calculation given by Equation \ref{index} holds as normal.
For the remainder of this paper, when we calculate index of abundance from a model that incorporates detectability (i.e., either this model or the following model that propagates error) we will calculate index of abundance under perfect detection, such that the index of abundance represents the mean expected count at point $j$ in stratum $i$ during year $t$ by observer $o$, \textit{given perfect detectability}.

\subsubsection{A Point-level Model that Includes Detectability and Propagates Error}

Because we are using estimated values of $p$ and $q$ (i.e., $\hat{p}$ and $\hat{q}$) from the NA-POPS database \citep{edwards_point_2023}, we must also have a way to propagate the uncertainty around these detectability estimates. \citet{bravington_variance_2021} gives us a method to propagate uncertainty for a detectability offset into a GAM model. Consider the general log offset term $\log(p q)$. Following \citet{bravington_variance_2021}, we can rewrite this offset term as follows:

\begin{equation}\label{offset}
	\log(pq) = log(\hat{p} \hat{q}) + \kappa^{(p)}\zeta + O(\zeta^2) + \kappa^{(q)}\xi + O(\xi^2).
\end{equation}
	 
\par Here, $log(\hat{p} \hat{q})$ is the log offset term with the estimated availability $\hat{p}$ and perceptibility $\hat{q}$ from NA-POPS. 
We also introduce two additional sets of terms: $\kappa^{(p)}\zeta + O(\zeta^2)$ and $\kappa^{(q)}\xi + O(\xi^2)$, which are the corresponding uncertainty propagation terms for availability and perceptibility, respectively.  
The parameters $\zeta$ and $\xi$ are basis coefficients for the variance propagation for $\hat{p}$ and $\hat{q}$, respectively, and play a similar role to that played by the basis coefficients in the GAM model \citep{bravington_variance_2021}. 
In a Bayesian context, we have that $\zeta \sim N(\boldsymbol{0}, \boldsymbol{V_p})$, where $V_p$ is the covariance matrix for $\hat{p}$, and $\xi \sim N(\boldsymbol{V_q})$, where $V_q$ is the covariance matrix for $\hat{q}$.

\par The design matrices for $\zeta$ and $\xi$, denoted here as $\kappa^{(p)}$ and $\kappa^{(q)}$, are both vectors that are obtained by taking the first partial derivatives of the log probabilities $p$ and $q$ and evaluating these at $\theta = \hat{\theta}$, i.e. at its maximum likelihood estimation. 
From \citet{solymos_calibrating_2013}, we have that availability $p(\theta) = 1 - \exp\left\{-t\phi\right\}$, where $\phi = \exp\left(\theta\right)$ represents the cue rate for a given species, regressed against various factors that affect cue rate (such as ordinal day, time since sunrise, or their quadratic terms). 
If we have a vector {\boldmath$\beta$} of $S$ parameters and a design matrix $X$, we can set $\theta = X\boldsymbol{\beta}$, and find that the first partial derivative with respect to $\beta_s$, $s \in \left[0, S\right]$, and hence the $s$th entry of the design matrix $\kappa^{(p)}$, is given by
\begin{equation*}\label{kappa_p}
	\kappa_{s}^{(p)} = \left.\dfrac{\partial \log p(\theta)}{\partial \beta_s}\right\vert_{\theta = \hat{\theta}} = \left. X_s \times \dfrac{t \exp\left\{X\boldsymbol{\beta}\right\}}{\exp\left\{t \exp\left\{X\boldsymbol{\beta}\right\}\right\} - 1} \right\vert_{\beta = \hat{\beta}}
\end{equation*}
	
\par If we now consider perceptibility, from \citet{solymos_calibrating_2013}, we have that perceptibility $q(\theta) = \dfrac{\pi \tau^2 \left\{1 - \exp\left(\dfrac{-r^2}{\tau^2}\right)\right\}}{\pi r^2}$, where $\tau = \exp(\theta)$ represents the effective detection radius for a given species, regressed against various factors that could effect effective detection radius (such as survey roadside status and forest coverage). 
If we have a vector {\boldmath$\beta$} of $S$ parameters and a design matrix $X$, we can set $\theta = X\boldsymbol{\beta}$, and find that the first partial derivative with respect to $\beta_s$, $s \in \left[0, S\right]$, and hence the $s$th entry of the design matrix $\kappa^{(q)}$, is given by

\begin{equation*}\label{kappa_q}
	\kappa_{s}^{(q)} = \left. \dfrac{\partial \log q(\theta)}{\partial \beta_s} \right\vert_{\theta = \hat{\theta}}= \left. X_s \left[\dfrac{{e^{-2X\boldsymbol{\beta}}} {2 \pi  e^{2X\boldsymbol{\beta}}} {\left(1 - e^{r^2 \left(-e^{-2X\boldsymbol{\beta}}\right)}\right)} - {2\pi r^2} {e^{r^2 \left(-e^{-2X\boldsymbol{\beta}}\right)}}}             {\pi {1-e^{r^2 \left(-e^{-2X\boldsymbol{\beta}}\right)}}}\right]  - log(\pi^2r^2) \right\vert_{\beta = \hat{\beta}}
\end{equation*}

\par Finally, the terms $O(\zeta^2)$ and $O(\xi^2)$ arise from the Taylor approximations that are used to arrive at Equation \ref{offset} \citep{bravington_variance_2021}. 
Since we only use the Taylor approximations up to the 2nd term of the Taylor series, our offset term is asymptotically accurate to $O(\zeta^2) + O(\xi^2) = O(\zeta^2 + \xi^2)$.
However, for the purposes of modelling in a Bayesian context, we can ignore these terms.

Putting everything together, we arrive at the following point-level model that includes the log offset term and variance propagation terms:
\begin{equation}\label{bbs_varprop}
	\log(\lambda_{j,i,t}) = \log(\hat{p} \hat{q})_{j,i,t} + \kappa_{j,i,t}^{(p)}\zeta + \kappa_{j,i,t}^{(q)}\xi + \alpha_i + \delta_{i,t} + \gamma_{i,t} + \psi_j + \omega_o + \eta I(o,j,t) + \epsilon_{j,i,t,o} \\
\end{equation}

\subsection{Data Acquisition}

\subsubsection{Breeding Bird Survey Data}

\par We used the R package \texttt{bbsBayes2} to download and process BBS data \citep{edwards_bbsbayes_2021}. 
For analysis with the route-level model, we followed the same data preparation steps as normal, in that data were downloaded from the USGS ScienceBase site, stratified based on a 1-degree by 1-degree block of latitude and longitude, prepared for modelling in Stan, and then modelled.
For point-level data, we accessed a database of known stop locations from the Canadian Wildlife Service BBS office, and matched these locations with each of the stops available from the stop-level data download from \texttt{bbsBayes2}.
Because we were only able to obtain known stop locations from Canadian Wildlife Service, our analysis is strictly limited to Canada.
We note, however, a method for estimating known BBS locations given a BBS route shapefile (CITE), and so future analyses could take advantage of that.

\subsubsection{Landcover Data}

\par We downloaded the following data products from the North American Land Change Monitoring System: Land Cover, 2010 (Landsat, 30m); Landcover, 30m, 2015 (Landsat and RapidEye); and North American Land Cover, 2020 (Landsat, 30m).
Thus, we were able to obtain landcover at 30m resolution for the years 2010, 2015, and 2020. 
For each known BBS point, we created a 400 m radius buffer around the point (representing the maximum survey distance for each point), and calculated the proportion of forest coverage for 2010, 2015, and 2020. 
We used linear interpolation at each point to obtain forest coverage from 2011 - 2014 and from 2016 - 2019. 
Because we were interested in analyzing data up to and including the year 2022, we simply copied the forest coverage value in 2020 forward for the years 2021 and 2022, so as to make conservative assumptions about how the landcover might have changed in the last two years.

\par Because the BBS is inherently a roadside survey, we did not have to classify whether a point was a roadside survey or not.
Instead, we simply set all points to be roadside surveys for the purposes of estimating detectability.

\subsubsection{Detectability Data}

\par We used the R package \texttt{napops} to calculate the value of availability $\hat{p}$ and perceptibility $\hat{q}$ at each point.
To obtain availability, we needed to have the time at which a point was run, and the day of the year that it was run.
Day of the year was trivially calculated as days since 1 January of that year.
Time of day was calculated as follows: given the start time and end time of a BBS route (which is available with the data download), we partitioned this duration of time into the number of points run for that particular route.
We note that normally the number of points run per route should be 50, but there is flexibility in what is considered a "complete" route.
These partitioned times were then used as estimated start times for each of the points. 
Of course, there is uncertainty associated with these start times, but we chose to ignore it this time.
Availability was then obtained by inputting the vector of start times, day of the year, and survey durations (3 minutes per point) into the avail() function in \texttt{napops}.
Finally, to obtain perceptibility, we input the vector of forest coverage associated with each point, roadside status (which was TRUE for all points), and the maximum survey radius (400 m for BBS points) into the percept() function in \texttt{napops}.

\par The \texttt{napops} R package was also updated for this paper to include the ability to access the covariance matrix for the associated availability and perceptibility models, as well as the ability to calculate the value of first derivative of the detection functions evaluated at its maximmum likelihood estimate.
Both of these values are necessary for the variance propagation model (see Appendix A).

\subsection{Case Study: Ovenbird Trends and Trajectories in Canada, 2010 - 2022}

\par We applied the point-level BBS model (Equation \ref{bbs-point}), detectability BBS model (Equation \ref{bbs-detect}), and the variance propagation BBS model (Equation \ref{bbs_varprop}) to the Ovenbird BBS data to compare trend estimates obtained by these three models to trend estimates obtained via the current BBS route-level model described in \citet{smith_spatially_2023}.
Using the methods as described above, we first ran a route-level model for the years 2010 - 2022 to obtain indices and trends for Ovenbird as a baseline comparison.
Then, we obtained the landcover and detectability data for Ovenbird and ran the detectability model for the same years.
For Ovenbird, we used the "best" models of availability and perceptibility as determined in \citet{edwards_point_2023}: the model that included Ordinal Day and its quadratic term was the best model for availability, and the model that included Roadside, Forest Coverage, and the interaction term was the best model for perceptibility.
Finally, we ran the variance propagation model for the same years as above.
These model runs resulted in four sets of indices and hence four time series.
We denote them as follows: ROUTE, for indices and trends from the route-level model (Equation \ref{bbs}); POINT, for indices and trends from the point-level model (Equation \ref{bbs-point}); DETECT, for indices and trends from the point-level model that includes detectability (Equation \ref{bbs-detect}); and VARPROP, for indices and trends from the point-level model that includes detectability and variance propagation (Equation \ref{bbs_varprop}).

\subsubsection{Comparing Indices and Trends from ROUTE versus POINT}\label{route-vs-point}

\par Before considering how detectability affects index and trend calculation from BBS data, we must first ensure that a point-level model does not significantly change the overall trends compared to the route model, and that the indices calculated from the point-level model vary predictively from the route-level model.
Put different, we want to ensure that the point-level model can serve as a reasonable proxy for the route-level model for later comparisons of detectability versus no detectability.

\par To assess how the POINT indices served as a proxy for ROUTE indices, we modelled each ROUTE index as a linear combination of its corresponding POINT index, for each route-year combination. 
That is:

$$	n_{{i,t}_{ROUTE}} \sim N(\alpha + \beta_i \times n_{{i,t}_{POINT}}, \sigma) $$
$$	\alpha \sim N(0,1) $$
$$	\beta \sim N(B, 1) $$
$$	B \sim N(50, 1) $$
$$	\sigma \sim exp(1)$$

If POINT indices are a reasonable proxy for ROUTE indices, then we would expect to see $\alpha \approx 0$ and $B \approx 50$; given there are 50 points per route, it is reasonable to assume that indices calculated at the route level should be approximately 50 times those calculated at the point level.

\par Similarly with trend, we modelled each ROUTE trend as a linear combination of its corresponding POINT trend, for each stratum.
That is:

$$ T_{ROUTE} \sim N(\alpha + \beta \times T_{POINT}, \sigma)$$
$$ \alpha \sim N(0,1) $$
$$ \beta \sim N(1,1) $$
$$ \sigma \sim exp(1) $$

If POINT trends are a reasonable proxy for ROUTE trends, then we would expect to see $\alpha \approx 0$ and $\beta \approx 1$, indicating a nearly 1-to-1 correspondence. 

\subsubsection{Variance Propagation Diagnostics}

\par \citet{bravington_variance_2021} gives a few relatively straightforward diagnostics to assess consistency between the detectability portion of the model and the abundance portion of the model, given the error propagation.
For this case study, we provide two diagnostics.
The first is to simply compare the indices and trends obtained from the VARPROP model to those obtained from the DETECT model to ensure that there are not large differences, particularly in space. 
We can assess this similar to subsection \ref{route-vs-point} where we simply model the VARPROP indices and trends as functions of the DETECT indices and trends.
Second, we assess the posterior distribution of the variance propagation parameters $\zeta$ and $\xi$.
A posterior distribution that centres reasonably close to 0 implies that there is no systematic bias in the detectability functions that contribute to the pattern of observations, and hence the detectability functions do not need "correction".

\subsubsection{Comparing Indices and Trends from POINT versus VARPROP and DETECT}

\par We are interested to see how the incorporation of detectability affects index and trend estimates of Ovenbird.
In particular, we are interested in seeing if including detectability in the BBS trend model can possibly correct for systematic biases that may be present due to changing forest coverage.
For example, consider a BBS point that has undergone signficant forest coverage change over the last decade (Figure TO DO).
At the beginning of the decade, suppose this point was heavily forested, and was territory for eight Ovenbirds. 
Because detectability in forested areas is generally lower than open areas due to sound attenuation \citep{yip_sound_2017}, we might expect an average observer to only detect, say, 30\% of these eight Ovenbirds, given they give a cue (i.e., sing) during the 3-minute point count.
If, a decade later, this point has the same number of Ovenbirds but with much less forest coverage, we might expect an average observer to detect a higher percentage of Ovenbirds (say, 80\%), because the Ovenbird song would attenuate less over the more open environment.
Without accounting for detectability, this may appear to be a population increase, whereas in reality the population has actually remained steady.

\par For this comparison, we focused on trend estimates for a ROUTE/STRATUM (TO DO) that experience a particularly high change in forest coverage, such that the forest coverage at the beginning of the time series was significantly higher than the forest coverage at the end of the time series.
Then, we compared trends and trajectories from the POINT model to those from the DETECT and VARPROP model, to assess if there was any differences given the changes in forest coverage.
We also conducted this comparison on a POINT/STRATUM where there was very little change.

\subsection{Analysis}
\par All analyses were conducted in R version 4.3.1 (CITATION).
All Bayesian models were coded in the Stan Probabilistic Language (CITE) and run using the \texttt{cmdstanr} R package.
All models were run for four independent chains and were allowed to warm up for 1000 iterations and sample for 2000 iterations per chain.
This resulted in a total of 8000 samples per parameter, per model.
We assessed convergence using the split R-hat statistic (CITE).
All models were run on one of two multi-core processing servers, one running Ubuntu 20.04.4 LTS and one running Ubuntu 20.04.6 LTS.

\par All code is available open-source at https://github.com/BrandonEdwards/bbs-point-level, and will be archived with a DOI upon acceptance of this paper.

\section{Results}

\section{Discussion}


	\bibliography{refs}
	
\section{Appendix A}
\end{document}
